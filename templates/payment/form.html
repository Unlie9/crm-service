{% extends "base.html" %}

{% block content %}
<div class="form-container">
  <h1 class="form-header">
    {% if object %}
      Update Payment
    {% else %}
      Create Payment
    {% endif %}
  </h1>


  <form method="post" class="form" id="payment-form">
    {% csrf_token %}
    {% for field in form %}
    <div class="form-group">
      <label for="{{ field.id_for_label }}" class="form-label">
        {{ field.label }}
      </label>
      {{ field }}

      <div class="form-error" id="error-{{ field.name }}"></div>
    </div>
    {% endfor %}

    <!-- Кнопка отправки -->
    <button type="submit" class="form-submit">
      {% if object %}
        Update Payment
      {% else %}
        Create Payment
      {% endif %}
    </button>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("payment-form");

  form.addEventListener("submit", function(event) {
      event.preventDefault();

      clearErrors();

      const isValid = validateForm();
      if (!isValid) {
        return;
      }

      const formData = new FormData(form);
      const url = form.getAttribute("action") || window.location.href;
      const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: formData
      })
      .then(response => {
        if (!response.ok) throw response;
        return response.json();
      })
      .then(data => {
        if (data.success) {

            window.location.href = data.redirect_url; 

        } else {
          clearErrors();
          showErrors(data.errors);
        }
      })
      .catch(async (errorResponse) => {
        if (errorResponse.json) {
          const errorData = await errorResponse.json();
          clearErrors();
          showErrors(errorData.errors);
        } else {
          console.error("Unexpected error occurred.");
        }
      });
  });

  function clearErrors() {
    document.querySelectorAll(".form-error").forEach(errorDiv => {
      errorDiv.textContent = "";
    });
  }

  function showErrors(errors) {
    for (const [field, messages] of Object.entries(errors)) {
      const errorDiv = document.getElementById(`error-${field}`);
      if (errorDiv) {
        errorDiv.textContent = messages.join(", ");
      }
    }
  }

  function validateForm() {
    let isValid = true;

    const namE = form.querySelector("[name='name']")
    const firstName = form.querySelector("[name='first_name']")
    const lastName = form.querySelector("[name='last_name']")
    const balance = form.querySelector("[name='balance']")

    if (namE.length < 4) {
      const errorDiv = document.getElementById("error-name");
      errorDiv.textContent = "Name of payment must be longer than 4 chars";
      isValid = false;
    } 

    if (firstName.length < 4) {
      const errorDiv = document.getElementById("error-first_name");
      errorDiv.textContent = "First name must be longer than 4 chars";
      isValid = false;
    } 

    if (lastName.length < 4) {
      const errorDiv = document.getElementById("last_name");
      errorDiv.textContent = "Last name must be longer than 4 chars";
      isValid = false;
    } 

    if (balance > 200000) {
      const errorDiv = document.getElementById("error-balance");
      errorDiv.textContent = "Balance can not be more than 200000";
      isValid = false;
    }

    return isValid

  }
});
</script>
{% endblock %}

{% block stylesheets %}
<style>
/* Общий стиль */
.form {
  display: block;
  margin-top: 0em;
  unicode-bidi: isolate;
  text-align: center;
}

/* Контейнер для формы */
.form-container {
  max-width: 600px;
  margin: 50px auto;
  padding: 30px;
  background: linear-gradient(to bottom, #ffffff, #f9f9f9);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
  border-radius: 10px;
  font-family: "Arial", sans-serif;
}

/* Заголовок формы */
.form-header {
  text-align: center;
  font-size: 28px;
  color: #333;
  margin-bottom: 20px;
}

/* Группы полей формы */
.form-group {
  margin-bottom: 20px;
}

/* Метка поля */
.form-label {
  display: block;
  font-weight: bold;
  color: #555;
  margin-bottom: 8px;
}

/* Поля ввода */
.form-input {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  border: 1px solid #ccc;
  border-radius: 5px;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-input:focus {
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
  outline: none;
}

/* Ошибки формы */
.form-error {
  color: #ff4d4d;
  font-size: 14px;
  margin-top: 5px;
}

/* Кнопка отправки */
.form-submit {
  display: block;
  width: 100%;
  padding: 12px;
  font-size: 18px;
  font-weight: bold;
  color: #fff;
  background-color: #4CAF50;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.form-submit:hover {
  background-color: #45a049;
  box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
}

/* Уведомление */
#notification {
  max-width: 400px;
  margin: 10px auto;
  padding: 10px;
  background: #4CAF50;
  color: white;
  text-align: center;
  border-radius: 5px;
}
</style>
{% endblock %}
